<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…±åŒå­˜éŒ¢ç³»çµ± 3.0 (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/98.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #008080; padding: 20px; font-family: "MS Sans Serif", Arial, sans-serif; display: flex; justify-content: center; }
        .window { width: 100%; max-width: 450px; }
        .progress-bar { height: 20px; border: 1px solid #808080; border-right-color: #ffffff; border-bottom-color: #ffffff; background: silver; position: relative; margin: 10px 0; }
        .progress-fill { height: 100%; background: #000080; width: 0%; transition: width 0.5s ease-in-out; }
        .stats { margin-bottom: 10px; }
        .stats p { margin: 5px 0; font-size: 14px; }
    </style>
</head>
<body>

<div class="window">
  <div class="title-bar">
    <div class="title-bar-text">Saving_App_Online.exe</div>
    <div class="title-bar-controls">
      <button aria-label="Minimize"></button>
      <button aria-label="Maximize"></button>
      <button aria-label="Close"></button>
    </div>
  </div>
  <div class="window-body">
    
    <fieldset>
      <legend>âš™ï¸ ç›®æ¨™è¨­å®š (è‡ªå‹•å„²å­˜è‡³é›²ç«¯)</legend>
      <div class="field-row">
        <label for="targetName">ç›®æ¨™åç¨±:</label>
        <input id="targetName" type="text" placeholder="è¼‰å…¥ä¸­..." style="width: 150px;"/>
      </div>
      <div class="field-row" style="margin-top: 5px;">
        <label for="targetAmount">ç›®æ¨™é‡‘é¡:</label>
        <input id="targetAmount" type="number" placeholder="è¼‰å…¥ä¸­..." style="width: 100px;"/>
        <button id="updateGoalBtn" style="margin-left: 10px;">æ›´æ–°ç›®æ¨™</button>
      </div>
    </fieldset>

    <div style="margin-top: 15px;">
        <h4 id="displayTargetName" style="margin: 0 0 5px 0;">è¼‰å…¥ä¸­...</h4>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <p style="text-align: right; margin: 0; font-size: 12px;" id="progressText">0 / 0 (0%)</p>
    </div>

    <fieldset style="margin-top: 15px;">
        <legend>ğŸ‘¥ å­˜æ¬¾æ˜ç´°</legend>
        <div class="stats">
            <p>ğŸ§‘â€ğŸ’» æ–¹æ–¼çš„å­˜æ¬¾ï¼š$<span id="user1Display">0</span></p>
            <p>ğŸ‘©â€â¤ï¸â€ğŸ‘© é™³ä¸ƒä¹çš„å­˜æ¬¾ï¼š$<span id="user2Display">0</span></p>
            <p><strong>ğŸ’° ç¸½è¨ˆé€²åº¦ï¼š$<span id="totalDisplay">0</span></strong></p>
        </div>
    </fieldset>

    <fieldset style="margin-top: 15px;">
      <legend>ğŸ’¸ æ–°å¢å­˜æ¬¾</legend>
      <div class="field-row">
        <label>å­˜å…¥è€…:</label>
        <select id="userSelect">
          <option value="user1">æ–¹æ–¼</option>
          <option value="user2">é™³ä¸ƒä¹</option>
        </select>
      </div>
      <div class="field-row" style="margin-top: 5px;">
        <label for="depositAmount">é‡‘é¡:</label>
        <input id="depositAmount" type="number" placeholder="è¼¸å…¥é‡‘é¡..." style="width: 100px;"/>
        <button id="saveBtn" style="margin-left: 10px;">ç¢ºèªå­˜å…¥</button>
      </div>
    </fieldset>

    <div class="status-bar" style="margin-top: 15px;">
      <p class="status-bar-field">ç¶²è·¯ç®¡ç†å°ˆå“¡</p>
      <p class="status-bar-field" id="connectionStatus">é€£ç·šä¸­...</p>
    </div>
  </div>
</div>

<script>
    // ==========================================
    // ğŸ‘‰ å°±åœ¨é€™è£¡ï¼è«‹æŠŠä½ æ‰¾åˆ°çš„ URL å’Œ Key è²¼åœ¨ä¸‹é¢é€™å…©è¡Œçš„å–®å¼•è™Ÿè£¡é¢ï¼š
    const SUPABASE_URL = 'https://xmxibtstjfeltpfuwkmx.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_YGs8gQsNI3ucGNjdr5c7rw_Zx1jpBH_';
    // ==========================================

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function fetchData() {
        try {
            document.getElementById('connectionStatus').innerText = 'æ­£åœ¨åŒæ­¥è³‡æ–™...';

            const { data: goalData } = await supabase.from('savings_goal').select('*').eq('id', 1).single();
            if (goalData) {
                document.getElementById('targetName').value = goalData.name;
                document.getElementById('targetAmount').value = goalData.target_amount;
                document.getElementById('displayTargetName').innerText = goalData.name;
            }

            const { data: depositsData } = await supabase.from('deposits').select('*');
            
            let user1Total = 0;
            let user2Total = 0;

            if (depositsData) {
                depositsData.forEach(record => {
                    if (record.depositor === 'user1') user1Total += record.amount;
                    if (record.depositor === 'user2') user2Total += record.amount;
                });
            }

            const totalSaved = user1Total + user2Total;
            const targetAmount = goalData ? goalData.target_amount : 1;
            
            let percentage = (totalSaved / targetAmount) * 100;
            if (percentage > 100) percentage = 100;

            document.getElementById('user1Display').innerText = user1Total;
            document.getElementById('user2Display').innerText = user2Total;
            document.getElementById('totalDisplay').innerText = totalSaved;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').innerText = `${totalSaved} / ${targetAmount} (${percentage.toFixed(1)}%)`;

            document.getElementById('connectionStatus').innerText = 'ğŸŸ¢ å·²é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«';
        } catch (error) {
            console.error('è®€å–éŒ¯èª¤:', error);
            document.getElementById('connectionStatus').innerText = 'ğŸ”´ é€£ç·šå¤±æ•—';
        }
    }

    document.getElementById('updateGoalBtn').onclick = async function() {
        const newName = document.getElementById('targetName').value;
        const newAmount = parseInt(document.getElementById('targetAmount').value);

        if(!newName || !newAmount) {
            alert('ç›®æ¨™åç¨±å’Œé‡‘é¡ä¸èƒ½ç‚ºç©ºï¼'); return;
        }

        document.getElementById('connectionStatus').innerText = 'æ›´æ–°ç›®æ¨™ä¸­...';
        await supabase.from('savings_goal').update({ name: newName, target_amount: newAmount }).
